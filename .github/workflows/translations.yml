name: Update Translations

on:
  schedule:
    # Run daily at 10am Eastern (3pm UTC during EDT, 2pm UTC during EST)
    - cron: '0 15 * * *'  # 3pm UTC for Daylight Time
  workflow_dispatch:  # Manual trigger
    inputs:
      target_language:
        description: 'Target language code (e.g., es, de, fr)'
        required: false
        default: 'all'
        type: string

jobs:
  translate:
    name: Run Translation Tool
    runs-on: ubuntu-slim
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTOR_TOKEN }}
        
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25.1.0'
          cache: 'npm'
          cache-dependency-path: 'docs/package-lock.json'
          
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
          
      - name: Install Node.js dependencies
        working-directory: ./docs
        run: npm ci
        
      - name: Generate translation files
        working-directory: ./docs
        run: |
          if [ "${{ github.event.inputs.target_language }}" = "all" ] || [ -z "${{ github.event.inputs.target_language }}" ]; then
            npm run write-translations
          else
            npm run write-translations -- --locale ${{ github.event.inputs.target_language }}
          fi
          
      - name: Generate heading IDs
        working-directory: ./docs
        run: npm run write-heading-ids
        
      - name: Run custom translation tool
        id: translate
        working-directory: ./docs
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          npm run translate
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 1 ]; then
            echo "No translations needed - skipping build and commit"
            echo "::notice::No translations were needed. All content is up to date."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        
      - name: Test build with Maven
        if: steps.translate.outputs.has_changes == 'true'
        id: maven-build
        run: mvn clean package -Pprod
        
      - name: Upload translation files on failure
        if: failure() && steps.maven-build.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: failed-translation-files-${{ github.run_id }}
          path: docs/i18n/
          retention-days: 5
          compression-level: 9
        
      - name: Commit and push translation updates
        if: steps.translate.outputs.has_changes == 'true'
        run: |
          git config --local user.email "${{ secrets.ACTOR_EMAIL }}"
          git config --local user.name "${{ secrets.ACTOR_NAME }}"
          
          # Check if there are changes to commit
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "chore: update translations"
            git push
          else
            echo "No translation changes to commit"
          fi
